version: '3.8'

services:
  # ============================================
  # LCP Dashboard Frontend - NO BUILD, runtime installation
  # ============================================
  lcp-front:
    image: node:18-alpine
    working_dir: /app
    environment:
      # Git config
      - GIT_REPO=${GIT_REPO:-https://github.com/fernando-ferreira-bitss/atlas-lcp-front.git}
      - GIT_BRANCH=${GIT_BRANCH:-main}
      - GIT_TOKEN=${GIT_TOKEN:-}

      # Vite environment variables
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-https://apilcp.brainitsolutions.com.br}
      - VITE_APP_NAME=${VITE_APP_NAME:-Dashboard LCP}
      - VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS:-false}

      # Node environment
      - NODE_ENV=production
      - HUSKY=0
    # ports:
    #   - "3001:80"  # Porta comentada para Swarm mode - Traefik acessa via rede interna
    networks:
      - lcp-network
      - n8n_traefik_proxy
    restart: unless-stopped
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 60s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        monitor: 30s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    command:
      - /bin/sh
      - -c
      - |
        echo 'ðŸ“¥ Installing git, nginx and wget...'
        apk add --no-cache git nginx wget
        echo 'ðŸ“¦ Cloning repository...'
        rm -rf /tmp/lcp-front
        if [ -n "$$GIT_TOKEN" ]; then
          REPO_URL=$$(echo $$GIT_REPO | sed "s|https://|https://$$GIT_TOKEN@|g")
          git clone --depth 1 --branch $$GIT_BRANCH $$REPO_URL /tmp/lcp-front
        else
          git clone --depth 1 --branch $$GIT_BRANCH $$GIT_REPO /tmp/lcp-front
        fi
        cp -r /tmp/lcp-front/* /app/
        cp -r /tmp/lcp-front/.* /app/ 2>/dev/null || true
        echo 'ðŸ“¦ Installing pnpm...'
        npm install -g pnpm
        echo 'ðŸ”§ Installing dependencies with pnpm...'
        cd /app
        pnpm install --no-frozen-lockfile
        echo 'ðŸ—ï¸ Building frontend with Vite...'
        pnpm run build
        echo 'ðŸ“ Configuring nginx...'
        cat > /etc/nginx/http.d/default.conf <<'EOF'
        server {
            listen 80;
            server_name _;
            root /app/dist;
            index index.html;

            # Gzip compression
            gzip on;
            gzip_vary on;
            gzip_min_length 1024;
            gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;

            # Security headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;

            # Static assets cache
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }

            # SPA routing - serve index.html for all routes
            location / {
                try_files $$uri $$uri/ /index.html;
            }

            # Health check endpoint
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
        EOF
        echo 'ðŸš€ Starting nginx...'
        nginx -g 'daemon off;'
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 180s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lcp-front.rule=Host(`lcp.brainitsolutions.com.br`)"
      - "traefik.http.routers.lcp-front.entrypoints=websecure"
      - "traefik.http.routers.lcp-front.tls.certresolver=letsencrypt"
      - "traefik.http.services.lcp-front.loadbalancer.server.port=80"
      - "traefik.http.services.lcp-front.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.lcp-front.loadbalancer.healthcheck.interval=10s"
      - "traefik.docker.network=n8n_traefik_proxy"

networks:
  lcp-network:
    driver: bridge
  n8n_traefik_proxy:
    external: true
